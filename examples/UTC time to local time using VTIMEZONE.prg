* calculate the time in different timezones, based on a VTIMEZONE component

DO LOCFILE("icalloader.prg")

LOCAL ICS AS String
LOCAL IC AS iCalendar
LOCAL ICProc AS ICSProcessor
LOCAL NYTimezone AS iCalCompTIMEZONE

LOCAL LocalTime AS Datetime
LOCAL UTCTime AS Datetime
LOCAL NYTime AS Datetime

* New York timezone settings (from 1967 to present)

TEXT TO m.ICS NOSHOW
BEGIN:VCALENDAR
VERSION:2.0
PRODID://RFC5545 example
BEGIN:VTIMEZONE
TZID:America/New_York
LAST-MODIFIED:20050809T050000Z
BEGIN:DAYLIGHT
DTSTART:19670430T020000
RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=-1SU;UNTIL=19730429T070000Z
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:STANDARD
DTSTART:19671029T020000
RRULE:FREQ=YEARLY;BYMONTH=10;BYDAY=-1SU;UNTIL=20061029T060000Z
TZOFFSETFROM:-0400
TZOFFSETTO:-0500
TZNAME:EST
END:STANDARD
BEGIN:DAYLIGHT
DTSTART:19740106T020000
RDATE:19750223T020000
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:DAYLIGHT
DTSTART:19760425T020000
RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=-1SU;UNTIL=19860427T070000Z
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:DAYLIGHT
DTSTART:19870405T020000
RRULE:FREQ=YEARLY;BYMONTH=4;BYDAY=1SU;UNTIL=20060402T070000Z
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:DAYLIGHT
DTSTART:20070311T020000
RRULE:FREQ=YEARLY;BYMONTH=3;BYDAY=2SU
TZOFFSETFROM:-0500
TZOFFSETTO:-0400
TZNAME:EDT
END:DAYLIGHT
BEGIN:STANDARD
DTSTART:20071104T020000
RRULE:FREQ=YEARLY;BYMONTH=11;BYDAY=1SU
TZOFFSETFROM:-0400
TZOFFSETTO:-0500
TZNAME:EST
END:STANDARD
END:VTIMEZONE
END:VCALENDAR
ENDTEXT

m.ICProc = CREATEOBJECT("ICSProcessor")
m.IC = m.ICProc.Read(m.ICS)

* local and UTC current time
m.LocalTime = DATETIME()
m.UTCTime = m.IC.UTCDatetime()

* get the NY timezone definition
m.NYTimezone = m.IC.GetTimezone("America/New_York")

* get its local time, based on UTC
m.NYTime = m.NYTimezone.ToLocalTime(m.UTCTime)

MESSAGEBOX(TEXTMERGE("Local Time: <<m.LocalTime>><<CHR(13)+CHR(10)>>UTC Time: <<m.UTCTime>><<CHR(13)+CHR(10)>>New York Time: <<m.NYTime>>"), 64, "Timezone in iCalendar")

